@startuml architecture_diagram
!define RECTANGLE class

skinparam backgroundColor #FFFFFF
skinparam handwritten false
skinparam defaultFontName Arial

' ===== CLIENT ZONE =====
rectangle "CLIENT ZONE" #E1F5FF {
    actor Client as "Client\nBrowser"
}

' ===== ORCHESTRATION LAYER =====
rectangle "ORCHESTRATION LAYER (Master Node)" #FFF4E6 {
    component LB as "Load Balancer\n(Nginx)\n\nðŸ“Œ ChÆ°Æ¡ng 8:\nLoad Balancing\n& Failover"
    component Gateway as "API Gateway\n(Flask Server)\n\nÄiá»u phá»‘i toÃ n bá»™\nhá»‡ thá»‘ng"
}

' ===== MIDDLEWARE LAYER =====
rectangle "MIDDLEWARE & DATA LAYER" #F3E5F5 {
    database SQLite as "SQLite Database\n\nðŸ“Œ ChÆ°Æ¡ng 5:\nUUID Identification\n\nLÆ°u Metadata:\nfile_id, title, node_url"
    storage Redis as "Redis Cache\n\nðŸ“Œ ChÆ°Æ¡ng 4,6:\nDistributed Locking\n(Redlock)\nCaching & Counter"
    queue RabbitMQ as "RabbitMQ\n\nðŸ“Œ ChÆ°Æ¡ng 3,4:\nMessage Queue\nAsynchronous\nBackground Jobs"
}

' ===== STORAGE & PROCESSING LAYER =====
rectangle "STORAGE & PROCESSING LAYER (Slaves & Workers)" #E8F5E9 {
    storage Node1 as "Storage Node 1\n(Slave Server 1)\n\nLÆ°u file váº­t lÃ½"
    storage Node2 as "Storage Node 2\n(Slave Server 2)\n\nðŸ“Œ ChÆ°Æ¡ng 7:\nData Replication"
    storage Node3 as "Storage Node 3\n(Slave Server 3)\n\nBackup Node"
    component Worker as "Worker\n(Image Processor)\n\nðŸ“Œ ChÆ°Æ¡ng 3:\nXá»­ lÃ½ háº­u ká»³\nNÃ©n áº£nh, Thumbnail"
}

' ===== LUá»’NG UPLOAD =====
Client -down-> LB : 1. POST /upload
LB -down-> Gateway : 2. Forward request
Gateway -down-> SQLite : 3. LÆ°u Metadata\n(UUID, title, node_url)
Gateway -down-> Node1 : 4. Lá»±a chá»n node\nlÆ°u file váº­t lÃ½
Node1 .right.> Node2 : 5. Auto Replicate
Node2 .right.> Node3 : 6. Backup
Gateway -down-> RabbitMQ : 7. Äáº©y tin nháº¯n\n"Xá»­ lÃ½ áº£nh"
RabbitMQ -down-> Worker : 8. Worker láº¥y task
Worker -up-> Node1 : 9. Äá»c áº£nh gá»‘c
Worker -down-> Node1 : 10. LÆ°u áº£nh\nÄ‘Ã£ xá»­ lÃ½

' ===== LUá»’NG DOWNLOAD =====
Client -down-> LB : 11. GET /download
Gateway -left-> Redis : 12. Check Cache
Redis .left.> Gateway : Cache Hit
Gateway -down-> SQLite : 13. Láº¥y node_url
Gateway -down-> Node1 : 14. Táº£i file
Gateway -left-> Redis : 15. Update Counter
Gateway -up-> Client : 16. Return file

' ===== HEALTH MONITORING =====
Gateway .down.> Node1 : Health Check
Gateway .down.> Node2 : Health Check
Gateway .down.> Node3 : Health Check

@enduml
